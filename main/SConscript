#Remember the macports command:  port contents packageName
import subprocess
import sys

if 'makeDocs' in COMMAND_LINE_TARGETS:
	print 'Generating doxygen documentation...'
	proc= subprocess.Popen(['doxygen', 'doxiConfig'], cwd='/Users/dtrimarchi/VPP/main')
	

THIRD_PARTY_INCS=[
			'/Users/dtrimarchi/third_party/eigen-3.2.7',
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/UMFPACK/Include',
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/SuiteSparse_config',
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/AMD/Include',
			'/Users/dtrimarchi/third_party/boost_1_60_0',
			'/Users/dtrimarchi/third_party/nlopt-2.4.2/api',
			'/opt/local/include',												# macPorts and nlopt include path
			'/opt/local/share/plplot5.11.1/examples/c++',							#include path for plplot example
			'/opt/local/include/plplot',
			'/Users/dtrimarchi/third_party/Ipopt-3.12.6/Ipopt/src/Interfaces',
			'/Users/dtrimarchi/third_party/Ipopt-3.12.6/include',
			'/Users/dtrimarchi/third_party/Ipopt-3.12.6/include/coin',
			]


THIRD_PARTY_LIBS=[
			'amd',
			'cholmod',
			'suitesparseconfig',
			'colamd',
			'umfpack',
			'plplotcxx',  #libs required by plplot
			'plplot',
			'nlopt',
			'BLAS',
			'ipopt'
		]
			
					
THIRD_PARTY_LIBPATH=[
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/AMD/Lib',
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/CHOLMOD/Lib',
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/SuiteSparse_config',
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/COLAMD/Lib',
			'/Users/dtrimarchi/third_party/SuiteSparse-4.5.2/UMFPACK/Lib',
			'/Users/dtrimarchi/third_party/nlopt-2.4.2/libs',
			'/System/Library/Frameworks/Accelerate.framework/Versions/Current/Frameworks/vecLib.framework/Versions/A',
			'/opt/local/lib', # macPorts and lnopt lib path
			'/Users/dtrimarchi/third_party/Ipopt-3.12.6/lib'
			]

# Do some work to produce the version info
import subprocess
import time
from shutil import copyfile

currentBranch = (subprocess.check_output(["hg", "branch"]).rstrip())
currentRevNumber=(subprocess.check_output(["hg", "identify","-n"]).rstrip())
currentHash = (subprocess.check_output(["hg", "id","-i"]).rstrip())
buildDate = time.strftime("%c").rstrip()

# Get the full abs path of the file in the src tree and produce the 
# path of the same file with the timestamp
srcFile= str(File('Version.prototypeCpp').srcnode())
destFile= Dir('.').srcnode().abspath +'/Version.cpp'

# Copy the Version.prototypeCpp to Version.cpp
copyfile(srcFile,destFile)

 
# gsed currentBranch, currentHash, buildDate
newText=""
with open(destFile) as f:
	newText=f.read()
	newText= newText.replace("currentBranch_stringVar", currentBranch ) 
	newText= newText.replace("currentRevNumber_stringVar", currentRevNumber )
	newText= newText.replace("currentHash_stringVar", currentHash )
	newText= newText.replace("buildDate_stringVar", buildDate )
	f.close()

with open(destFile, "w") as f:
    f.write(newText)
    f.close()

# Get the environement 
env = DefaultEnvironment()

#Compile Debug mode
#env.Append(CCFLAGS= '-g')
#env.Append(CPPFLAGS ='-Wc++11-extensions')
env.Append(LINKFLAGS ='-framework Accelerate -lm -ldl')

#warning: use of enumeration in a nested name specifier is a
#      C++11 extension [-Wc++11-extensions]

env.Append(CPPPATH=['exceptions', THIRD_PARTY_INCS])

# Build - this is like in scons man14.3, but VPPException.o remains in the 
# source build instead of being sent over to the build dir. Why? 
env.Program('VPP', [ '#main/exceptions/VPPException.cpp' , Glob('*.cpp')],
		LIBS=THIRD_PARTY_LIBS,
		LIBPATH=THIRD_PARTY_LIBPATH
	)

# And now proceed to the subFolders
SConscript('''unitTest/SConscript'''.split())

